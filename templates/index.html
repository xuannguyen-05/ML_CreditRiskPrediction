<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CreditVision - Dự đoán Tín dụng</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='style.css') }}"
    />
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm">
      <div class="container">
        <a class="navbar-brand fw-bold" href="#">CREDITVISION</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link active" href="#">Trang chủ</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#form-section">Dự đoán rủi ro</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#">Về chúng tôi</a>
            </li>
            <li class="nav-item"><a class="nav-link" href="#">Liên hệ</a></li>
          </ul>
        </div>
      </div>
    </nav>

    <header class="hero-section text-white text-center">
      <div
        class="container d-flex flex-column justify-content-center align-items-center"
        style="height: 100%"
      >
        <h1 class="display-4 fw-bold">Giải pháp Tín dụng Thông minh</h1>
        <p class="lead col-md-8">
          Sử dụng công nghệ AI Machine Learning để dự đoán rủi ro tín dụng nhanh
          chóng và chính xác. Hỗ trợ ra quyết định cho các khoản vay của bạn.
        </p>
        <a href="#form-section" class="btn btn-primary btn-lg mt-3"
          >Thử nghiệm mô hình ngay!</a
        >
      </div>
    </header>

    <section class="services-section py-5">
      <div class="container">
        <h2 class="text-center mb-5 fw-light">Các Dịch Vụ Của Chúng Tôi</h2>
        <div class="row text-center">
          <div class="col-md-4 mb-3">
            <div class="card h-100 shadow-sm border-0">
              <div class="card-body">
                <h5 class="card-title text-primary">Vay Tiêu Dùng</h5>
                <p class="card-text">
                  Giải pháp vay vốn linh hoạt cho các nhu cầu cá nhân, mua sắm,
                  du lịch.
                </p>
              </div>
            </div>
          </div>
          <div class="col-md-4 mb-3">
            <div class="card h-100 shadow-sm border-0">
              <div class="card-body">
                <h5 class="card-title text-primary">Vay Mua Xe</h5>
                <p class="card-text">
                  Hỗ trợ tài chính để sở hữu chiếc xe mơ ước với lãi suất ưu
                  đãi.
                </p>
              </div>
            </div>
          </div>
          <div class="col-md-4 mb-3">
            <div class="card h-100 shadow-sm border-0">
              <div class="card-body">
                <h5 class="card-title text-primary">Thẻ Tín Dụng</h5>
                <p class="card-text">
                  Chi tiêu trước, trả sau với nhiều ưu đãi hấp dẫn từ các đối
                  tác.
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="form-section" class="py-5 bg-light">
      <div class="container">
        <div class="row">
          <div class="col-lg-10 col-xl-8 mx-auto">
            <div class="card shadow-lg border-0" style="border-radius: 1rem">
              <div class="card-body p-4 p-md-5">
                <h2 class="text-center mb-4 text-dark">
                  Form Dự đoán Rủi ro Tín dụng
                </h2>
                <p class="text-center text-muted mb-4">
                  Nhập thông tin của khách hàng để đánh giá khả năng vỡ nợ.
                </p>

                <form id="prediction-form">
                  <div class="row">
                    <div class="col-md-6">
                      <h5 class="form-section">Thông tin cá nhân</h5>
                      <div class="mb-3">
                        <label for="Age" class="form-label">Tuổi</label
                        ><input
                          type="number"
                          class="form-control"
                          id="Age"
                          required
                        />
                      </div>

                      <div class="mb-3">
                        <label for="Income" class="form-label"
                          >Thu nhập (hàng năm) (VNĐ)</label
                        >
                        <input
                          type="text"
                          class="form-control"
                          id="Income"
                          inputmode="numeric"
                          oninput="formatCurrency(this)"
                          required
                        />
                      </div>

                      <div class="mb-3">
                        <label for="Education" class="form-label"
                          >Trình độ học vấn</label
                        ><select class="form-select" id="Education" required>
                          <option value="High School">High School</option>
                          <option value="Bachelor's">Bachelor's</option>
                          <option value="Master's">Master's</option>
                          <option value="PhD">PhD</option>
                        </select>
                      </div>
                      <div class="mb-3">
                        <label for="MaritalStatus" class="form-label"
                          >Tình trạng hôn nhân</label
                        ><select
                          class="form-select"
                          id="MaritalStatus"
                          required
                        >
                          <option value="Single">Single</option>
                          <option value="Married">Married</option>
                          <option value="Divorced">Divorced</option>
                        </select>
                      </div>
                      <div class="mb-3">
                        <label for="HasDependents" class="form-label"
                          >Có người phụ thuộc?</label
                        ><select
                          class="form-select"
                          id="HasDependents"
                          required
                        >
                          <option value="No">No</option>
                          <option value="Yes">Yes</option>
                        </select>
                      </div>
                      <div class="mb-3">
                        <label for="HasCoSigner" class="form-label"
                          >Có người đồng ký tên?</label
                        ><select class="form-select" id="HasCoSigner" required>
                          <option value="No">No</option>
                          <option value="Yes">Yes</option>
                        </select>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <h5 class="form-section">Thông tin Tín dụng & Vay</h5>

                      <div class="mb-3">
                        <label for="LoanAmount" class="form-label"
                          >Số tiền vay (VNĐ)</label
                        >
                        <input
                          type="text"
                          class="form-control"
                          id="LoanAmount"
                          inputmode="numeric"
                          oninput="formatCurrency(this)"
                          required
                        />
                      </div>
                      <div class="mb-3">
                        <label for="LoanTerm" class="form-label"
                          >Kỳ hạn vay (tháng)</label
                        ><input
                          type="number"
                          class="form-control"
                          id="LoanTerm"
                          required
                        />
                      </div>
                      <div class="mb-3">
                        <label for="InterestRate" class="form-label"
                          >Lãi suất (%)</label
                        ><input
                          type="number"
                          step="0.01"
                          class="form-control"
                          id="InterestRate"
                          required
                        />
                      </div>
                      <div class="mb-3">
                        <label for="LoanPurpose" class="form-label"
                          >Mục đích vay</label
                        ><select class="form-select" id="LoanPurpose" required>
                          <option value="Auto">Auto</option>
                          <option value="Business">Business</option>
                          <option value="Education">Education</option>
                          <option value="Home">Home</option>
                          <option value="Other">Other</option>
                        </select>
                      </div>
                      <div class="mb-3">
                        <label for="CreditScore" class="form-label"
                          >Điểm tín dụng</label
                        ><input
                          type="number"
                          class="form-control"
                          id="CreditScore"
                          required
                        />
                      </div>
                      <div class="mb-3">
                        <label for="DTIRatio" class="form-label"
                          >Tỷ lệ DTI</label
                        ><input
                          type="number"
                          step="0.01"
                          class="form-control"
                          id="DTIRatio"
                          required
                        />
                      </div>
                      <div class="mb-3">
                        <label for="EmploymentType" class="form-label"
                          >Loại hình công việc</label
                        ><select
                          class="form-select"
                          id="EmploymentType"
                          required
                        >
                          <option value="Unemployed">Unemployed</option>
                          <option value="Self-employed">Self-employed</option>
                          <option value="Part-time">Part-time</option>
                          <option value="Full-time">Full-time</option>
                        </select>
                      </div>
                      <div class="mb-3">
                        <label for="MonthsEmployed" class="form-label"
                          >Số tháng làm việc</label
                        ><input
                          type="number"
                          class="form-control"
                          id="MonthsEmployed"
                          required
                        />
                      </div>
                      <div class="mb-3">
                        <label for="NumCreditLines" class="form-label"
                          >Số lượng hạn mức tín dụng</label
                        ><input
                          type="number"
                          class="form-control"
                          id="NumCreditLines"
                          required
                        />
                      </div>
                      <div class="mb-3">
                        <label for="HasMortgage" class="form-label"
                          >Có thế chấp?</label
                        ><select class="form-select" id="HasMortgage" required>
                          <option value="No">No</option>
                          <option value="Yes">Yes</option>
                        </select>
                      </div>
                    </div>
                  </div>
                  <button
                    type="submit"
                    class="btn btn-primary w-100 btn-lg mt-3"
                  >
                    Gửi Dự đoán
                  </button>
                </form>

                <div id="result" class="text-center"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <footer class="py-4 bg-dark text-white text-center">
      <div class="container">
        <p class="mb-0">&copy; 2025 CreditVision. Đồ án môn học.</p>
      </div>
    </footer>

    <script>
      /*
       * HÀM MỚI (1): Tự động định dạng tiền tệ khi người dùng gõ
       */
      function formatCurrency(input) {
        // 1. Lấy giá trị, xóa mọi thứ không phải là số (giữ lại số)
        let value = input.value.replace(/[^\d]/g, "");

        // 2. Nếu không có giá trị, để trống
        if (value === "" || value === "0") {
          input.value = "";
        } else {
          // 3. Định dạng số theo kiểu vi-VN (dùng dấu chấm)
          // ví dụ: 20000000 -> 20.000.000
          let formattedValue = new Intl.NumberFormat("vi-VN").format(value);
          input.value = formattedValue;
        }
      }

      /*
       * HÀM MỚI (2): Xóa định dạng tiền tệ trước khi gửi đi
       */
      function unformatCurrency(value) {
        // ví dụ: "20.000.000" -> "20000000"
        return value.replace(/[.]/g, "");
      }

      /*
       * HÀM SUBMIT FORM (ĐÃ CẬP NHẬT)
       */
      document
        .getElementById("prediction-form")
        .addEventListener("submit", function (e) {
          e.preventDefault();

          // Lấy giá trị ĐÃ ĐỊNH DẠNG từ form
          let incomeFormatted = document.getElementById("Income").value;
          let loanAmountFormatted = document.getElementById("LoanAmount").value;

          // 1. Thu thập dữ liệu
          let formData = {
            // Dùng hàm MỚI (2) để xóa dấu chấm trước khi gửi đi
            Income: parseFloat(unformatCurrency(incomeFormatted)),
            LoanAmount: parseFloat(unformatCurrency(loanAmountFormatted)),

            // Các trường khác giữ nguyên
            Age: parseFloat(document.getElementById("Age").value),
            CreditScore: parseFloat(
              document.getElementById("CreditScore").value
            ),
            MonthsEmployed: parseFloat(
              document.getElementById("MonthsEmployed").value
            ),
            NumCreditLines: parseFloat(
              document.getElementById("NumCreditLines").value
            ),
            InterestRate: parseFloat(
              document.getElementById("InterestRate").value
            ),
            LoanTerm: parseFloat(document.getElementById("LoanTerm").value),
            DTIRatio: parseFloat(document.getElementById("DTIRatio").value),
            Education: document.getElementById("Education").value,
            EmploymentType: document.getElementById("EmploymentType").value,
            HasMortgage: document.getElementById("HasMortgage").value,
            HasDependents: document.getElementById("HasDependents").value,
            HasCoSigner: document.getElementById("HasCoSigner").value,
            MaritalStatus: document.getElementById("MaritalStatus").value,
            LoanPurpose: document.getElementById("LoanPurpose").value,
          };

          let resultDiv = document.getElementById("result");
          resultDiv.innerHTML = "<h4>Đang phân tích...</h4>";
          resultDiv.className = "text-center status-loading"; // Class loading

          // 2. Gửi dữ liệu (đã được làm sạch) lên backend
          fetch("/predict", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(formData),
          })
            .then((response) => response.json())
            .then((data) => {
              // 3. Hiển thị kết quả (Logic "Đèn giao thông")
              if (data.error) {
                resultDiv.innerHTML = `<h3>Lỗi Hệ thống</h3><p>${data.error}</p>`;
                resultDiv.className = "text-center status-reject";
              } else {
                let newResultHTML = `
                        <h3>Hành động đề xuất: ${data.recommendation}</h3>
                        <span class="score">${data.risk_score}</span>
                        (Điểm rủi ro vỡ nợ)
                        <hr>
                        <p class="reason"><strong>Ghi chú từ AI:</strong> ${data.reason}</p>
                    `;

                resultDiv.innerHTML = newResultHTML;

                // Gán class màu (status-approve, status-reject, status-review)
                resultDiv.className = `text-center ${data.recommendation_class}`;
              }
            })
            .catch((error) => {
              resultDiv.innerHTML = `<h3>Lỗi kết nối</h3><p>${error}</p>`;
              resultDiv.className = "text-center status-reject";
            });
        });
    </script>
  </body>
</html>
